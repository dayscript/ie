'use strict';
<<<<<<< HEAD
var path = require('path');
var childProcess = require('child_process');
var objectAssign = require('object-assign');
var Promise = require('pinkie-promise');

module.exports = function (target, opts) {
=======
const path = require('path');
const childProcess = require('child_process');
const isWsl = require('is-wsl');

module.exports = (target, opts) => {
>>>>>>> be4427ec9de1b66f0b9db9482bab10352696cef7
	if (typeof target !== 'string') {
		return Promise.reject(new Error('Expected a `target`'));
	}

<<<<<<< HEAD
	opts = objectAssign({wait: true}, opts);

	var cmd;
	var appArgs = [];
	var args = [];
	var cpOpts = {};
=======
	opts = Object.assign({wait: true}, opts);

	let cmd;
	let appArgs = [];
	let args = [];
	const cpOpts = {};
>>>>>>> be4427ec9de1b66f0b9db9482bab10352696cef7

	if (Array.isArray(opts.app)) {
		appArgs = opts.app.slice(1);
		opts.app = opts.app[0];
	}

	if (process.platform === 'darwin') {
		cmd = 'open';

		if (opts.wait) {
			args.push('-W');
		}

		if (opts.app) {
			args.push('-a', opts.app);
		}
<<<<<<< HEAD
	} else if (process.platform === 'win32') {
		cmd = 'cmd';
		args.push('/c', 'start', '""');
=======
	} else if (process.platform === 'win32' || isWsl) {
		cmd = 'cmd' + (isWsl ? '.exe' : '');
		args.push('/c', 'start', '""', '/b');
>>>>>>> be4427ec9de1b66f0b9db9482bab10352696cef7
		target = target.replace(/&/g, '^&');

		if (opts.wait) {
			args.push('/wait');
		}

		if (opts.app) {
			args.push(opts.app);
		}

		if (appArgs.length > 0) {
			args = args.concat(appArgs);
		}
	} else {
		if (opts.app) {
			cmd = opts.app;
		} else {
<<<<<<< HEAD
			cmd = path.join(__dirname, 'xdg-open');
=======
			cmd = process.platform === 'android' ? 'xdg-open' : path.join(__dirname, 'xdg-open');
>>>>>>> be4427ec9de1b66f0b9db9482bab10352696cef7
		}

		if (appArgs.length > 0) {
			args = args.concat(appArgs);
		}

		if (!opts.wait) {
<<<<<<< HEAD
			// xdg-open will block the process unless
			// stdio is ignored even if it's unref'd
			cpOpts.stdio = 'ignore';
=======
			// `xdg-open` will block the process unless
			// stdio is ignored and it's detached from the parent
			// even if it's unref'd
			cpOpts.stdio = 'ignore';
			cpOpts.detached = true;
>>>>>>> be4427ec9de1b66f0b9db9482bab10352696cef7
		}
	}

	args.push(target);

	if (process.platform === 'darwin' && appArgs.length > 0) {
		args.push('--args');
		args = args.concat(appArgs);
	}

<<<<<<< HEAD
	var cp = childProcess.spawn(cmd, args, cpOpts);

	if (opts.wait) {
		return new Promise(function (resolve, reject) {
			cp.once('error', reject);

			cp.once('close', function (code) {
=======
	const cp = childProcess.spawn(cmd, args, cpOpts);

	if (opts.wait) {
		return new Promise((resolve, reject) => {
			cp.once('error', reject);

			cp.once('close', code => {
>>>>>>> be4427ec9de1b66f0b9db9482bab10352696cef7
				if (code > 0) {
					reject(new Error('Exited with code ' + code));
					return;
				}

				resolve(cp);
			});
		});
	}

	cp.unref();

	return Promise.resolve(cp);
};
