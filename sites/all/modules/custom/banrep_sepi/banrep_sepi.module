<?php

    /**
     * Implements hook_cron();
    */
    function banrep_sepi_cron(){
        $enviroment = 'dev';
        $path_in = 'private://'.'sepi-in-'.$enviroment;
        $path_out = 'private://'.'sepi-out-'.$enviroment;
        $files_in_folder = [];
        $files = [];
        watchdog('banrep_sepi', 'Iniciado', $variables = array(), $severity = WATCHDOG_INFO, $link = NULL);
        $files_in_folder = file_scan_directory($path_in, $mask = '/.*\.json$/', $options = array(), $depth = 0);
        
        foreach($files_in_folder as $key => $file){
            watchdog('banrep_sepi', 'Procesando archivo '.$file->uri , $variables = array(), $severity = WATCHDOG_INFO, $link = NULL);
            $contents_file = encodeToIso(file_get_contents($file->uri));
            $files[$file->name] = [ 
                'metadata' =>$file, 
                'contents' => json_decode($contents_file),
            ];

            $files[$file->name]['result'] = _create_node_publication($files[$file->name]);

            watchdog('banrep_sepi', 'Procesamiento completo' , $variables = array(), $severity = WATCHDOG_INFO, $link = NULL);
        }

        watchdog('banrep_sepi', 'Finalizado', $variables = array(), $severity = WATCHDOG_INFO, $link = NULL);
    }

    /**
     * Function to fix acents
     */
    function encodeToIso($string) { 
        return mb_convert_encoding($string,'utf-8','ISO-8859-15');
    } 
    
    /**
     * Function to create the publication node
     */
    function _create_node_publication($publication){
        
        $result = null;
        $nid = 0;
        
        $query = new EntityFieldQuery();
        $query->entityCondition('entity_type', 'node')
        ->entityCondition('bundle', 'publication')
        //->fieldCondition('field_sepi', 'value', 0000, '=');
        ->fieldCondition('field_sepi', 'value', $publication['contents']->identificador_sepi, '=');
        $result = $query->execute();
        $nid =  _get_nid($result);
        $entity_type = 'node';
        
        if( !is_null($nid) && is_numeric($nid) ){ // update entity
            // return $publication;    
            $node = node_load($nid);
            $node_wrapper = entity_metadata_wrapper($entity_type, $node);
            
  
        }else{ // create entity
            
            $entity = entity_create($entity_type, array('type' => 'publication'));
            $node_wrapper = entity_metadata_wrapper($entity_type, $entity);
        
        }

        $node_wrapper->field_pub_type->set( _get_type_publication( $publication['contents']->tipopub ) );
        $node_wrapper->title            = (!empty($publication['contents']->titulo)) ? $publication['contents']->titulo: NULL;
        $node_wrapper->field_title_en   = (!empty($publication['contents']->titulo_otroidioma )) ? $publication['contents']->titulo_otroidioma: NULL;
        $node_wrapper->field_url        = ['url' => $publication['contents']->url, 'title' => '', 'attributes'=>'' ];
        $node_wrapper->field_doi        = (!empty($publication['contents']->doi)) ? ['url' => $publication['contents']->doi, 'attributes'=>'' ]: NULL;
        $node_wrapper->field_sepi       = (!empty($publication['contents']->identificador_sepi )) ? $publication['contents']->identificador_sepi: NULL;
        $node_wrapper->field_number     = (!empty($publication['contents']->numero)  ? $publication['contents']->numero: null);
        $node_wrapper->field_page       = (!empty($publication['contents']->paginas) ? $publication['contents']->paginas: null);
        $node_wrapper->field_volumen    = (!empty($publication['contents']->volumen) ? $publication['contents']->volumen: null);
        $node_wrapper->field_pub_city   = (!empty($publication['contents']->ciudad)  ? $publication['contents']->ciudad: null);

        $node_wrapper->field_mag_name   = (!empty($publication['contents']->revista) ? $publication['contents']->editorial:null );
        $node_wrapper->field_pub_serie  = (!empty($publication['contents']->serie) ? $publication['contents']->editorial:null );
        $node_wrapper->field_editorial  = (!empty($publication['contents']->editorial) ? $publication['contents']->editorial:null );
        if( !empty($publication['contents']->fecha_aceptacion) ){
            $node_wrapper->field_act_date_start   =  strtotime($publication['contents']->fecha_aceptacion);
        }

        if( !empty($publication['contents']->fecha_publicacion) ){
            $node_wrapper->field_date   =  strtotime($publication['contents']->fecha_publicacion);
        }
        

        if($publication['contents']->archivo_aprobacion){
           $node_wrapper->field_archivo_de_aprobacion =  $publication['contents']->archivo_aprobacion;
        }
        
        $node_wrapper->field_publication_year = (!empty($publication['contents']->anopublicacion) ? $publication['contents']->anopublicacion:null);
        
        $node_wrapper->field_jel = [];
        if( !empty($publication['contents']->cod_jel) ){
            $codes = [];
            $terms = explode(',', $publication['contents']->cod_jel);
            foreach ($terms as $key => $term) {
                $codes[] =  _get_taxonomy_by_name($term, $vocabulary = 'jel');
            }
            $node_wrapper->field_jel->set($codes);
        }

        $node_wrapper->field_publication_tags = [];
        if( !empty($publication['contents']->keywords) ){
            $codes = [];
            $terms = explode(',', $publication['contents']->keywords);
            foreach ($terms as $key => $term) {
                $codes[] =  _get_taxonomy_by_name($term, $vocabulary = 'tags');
            }
            $node_wrapper->field_publication_tags->set($codes);
        }
       
        if( !empty($publication['contents']->clasificacion) ){
            $node_wrapper->field_concept_type = [];
            $node_wrapper->field_concept_type->set( [_get_type_publication($publication['contents']->clasificacion) ]);
        }

        if( !empty($publication['contents']->concepto) ){
            $node_wrapper->field_concept = _get_node_concept($publication['contents']->concepto);
        }
        
        
        // $node_wrapper->field_role_within_publication->set();
        
        $author_tid = _get_autor_for_mail( $publication['contents']->autor_principal->correo );
        
        if( !is_null($author_tid) ){ 
            $node_wrapper->field_main_author_reference = $author_tid;
        }   
          
        

        unset($node_wrapper->field_co_authors);
        $node_wrapper->field_other_co_authors = null;
        
        
        $node_wrapper->save(true);
        
        array_unshift($publication['contents']->coautores,$publication['contents']->autor_principal);
        
        
        if(is_array($publication['contents']->coautores) ){
            $publication['contents']->coautores = _create_coauthors($publication['contents']->coautores, $node_wrapper);
        }
    
        return $publication;

    }

    /**
     * function to create authors in publication
     */
    function _create_coauthors($co_authors, $node_wrapper){
        $node = node_load($node_wrapper->nid->value());

        switch ($node_wrapper->field_pub_type->value()) {
            case PUB_TYPE_BOOK:
            case PUB_TYPE_ESPE_MAGAZINE:
                $values['field_name'] = 'field_co_authors';

                //delete entity collection if exists

                foreach($co_authors as $index => $author){
                    $entity = entity_create('field_collection_item', $values);
                    $entity->setHostEntity('node', $node);
                    $tid = ( empty($author->correo) ) ? _get_taxonomy_by_name( $author->nombre,'autores_externos' ): _get_autor_for_mail($author->correo);

                    $entity->field_co_autor[LANGUAGE_NONE][0]['tid'] = $tid;
                    if( !empty($author->rol) ){
                        $role_in_pub = _get_taxonomy_by_name( $author->rol,'categorias_de_conceptos' );
                        $entity->field_role_within_publicat[LANGUAGE_NONE][0]['tid'] = $role_in_pub ;    
                    }                      
                    $entity->save(TRUE);
                    
                    if($index != 0 && !is_null($tid) ){
                        $node->field_other_co_authors[LANGUAGE_NONE][]['tid'] = $tid; 
                    }

                    if( !empty($author->correo) ){
                        if( $term_id = _get_autor_for_mail($author->correo) ){
                            _create_node_pub_user($node_wrapper,$term_id, ( isset($role_in_pub) ? $role_in_pub:null ));
                        }
                    }
                }
                node_save($node);
                break;
            
            default:
                foreach($co_authors as $index => $author){
                    $tid = ( empty($author->correo) ) ? _get_taxonomy_by_name( $author->nombre,'autores_externos' ): _get_autor_for_mail($author->correo);
                    if($index != 0){
                        $node_wrapper->field_other_co_authors[] = $tid; 
                    }
                    if( !empty($author->correo) ){
                        if( $term_id = _get_autor_for_mail($author->correo) ){
                            _create_node_pub_user($node_wrapper,$term_id, $node_wrapper->field_concept->value() );
                        }
                    }
                }
                $node_wrapper->save(TRUE);
                break;
    
        }
        return $co_authors;
    }

    /**
     * function to create node pub_user
     */
    function _create_node_pub_user( $node_wrapper, $term_id, $role_in_pub ){

        $author_interno = taxonomy_term_load($term_id);

        if( isset( $author_interno->field_user_reference['und'][0]['target_id'] ) ){
            $query = new EntityFieldQuery();
            $query->entityCondition('entity_type', 'node')
                  ->entityCondition('bundle', 'pub_user')
                    // ->fieldCondition('field_sepi', 'value', 0000, '=');
                  ->fieldCondition('field_user_reference', 'target_id', $author_interno->field_user_reference['und'][0]['target_id'] , '=')
                  ->fieldCondition('field_publicacion', 'target_id', $node_wrapper->nid->value(), '=');
            
            $entity_type = 'node';
            $result = $query->execute();
            $nid    =  _get_nid($result);
            
       
            if( !is_null($nid) && is_numeric($nid) ){ // update entity
                $node = node_load($nid);
                $pub_wrapper = entity_metadata_wrapper($entity_type, $node);
            }
            else{
                $entity = entity_create($entity_type, array('type' => 'pub_user'));
                $pub_wrapper = entity_metadata_wrapper($entity_type, $entity);
            }
    
            $pub_wrapper->title                   = $node_wrapper->title->value(). ' - ' . $author_interno->name;
            $pub_wrapper->field_user_reference    = $author_interno->field_user_reference['und'][0]['target_id'];
            $pub_wrapper->field_publicacion       = $node_wrapper->nid->value();
            
            
            $pub_wrapper->field_puntaje          = _get_points_for_role_and_route($author_interno->field_user_reference['und'][0]['target_id'],$role_in_pub);

            // $node_wrapper->field_main_author->set();
            // $node_wrapper->field_estado_publicaci_n->set();
            // $node_wrapper->field_research_group->set();
            // $node_wrapper->field_order->set();
            
            // $node_wrapper->field_puntaje_usado->set();
            // $node_wrapper->field_log_puntaje->set();
            $pub_wrapper->save();
        }
    }

    /**
     * function to get nid to node
     */
    function _get_nid($result){
        if( isset($result['node']) && isset( $result['node'][key($result['node'])]) ){
            return (int)$result['node'][key($result['node'])]->nid;
        }
        return null;
    }

    /**
     * function to get tid in author taxonomy
     */
    function _get_autor_for_mail($mail){
        if($user = user_load_by_mail($mail)) {
            $query = new EntityFieldQuery();
            $query->entityCondition('entity_type', 'taxonomy_term')
            ->entityCondition('bundle', 'autores_externos')
            ->fieldCondition('field_user_reference', 'target_id', $user->uid, '=');
            $result = $query->execute();
            return key($result['taxonomy_term']);

        }else{
            return null;
        }
    }


    /**
     * function to get tid by name of taxonomy
     */
    function _get_taxonomy_by_name($name, $vocabulary = 'autores_externos'){
        
        if($tid = taxonomy_get_term_by_name($name, $vocabulary)){
            return key($tid) ;
        }
        
        return null;
    }

    function _get_node_concept($title){
        if($nodes = node_load_multiple(NULL, array("title" => $title)) ){
            return key($nodes);
        }else{
            return null;
        }
        
    }

    /**
     * function to get tid by name in taxonomy
     */
    function _get_type_publication( $name, $vocabulary = 'categorias_de_conceptos' ){
        $tid = key(taxonomy_get_term_by_name($name, $vocabulary) );
        if( $tid ){
            return $tid;
        }
        $types = array(
            'Artículo' => '201',
            'Revista Espe' =>'20662',
            'Libro'=> '206',
            'Capitulo de libro' => '1',
            'Documento de trabajo'=> '2951',
            'Otros Documentos'=>'20708',
        );
        return ( isset($types[$name]) ) ? $types[$name]:null;
    }

     

    /*
    *   function for get points to pub_user
    */
    function _get_points_for_role_and_route($uid, $tid){
        $term = taxonomy_term_load($tid);
        $user = user_load($uid);
        $collections = $term->field_puntajes[LANGUAGE_NONE];
        foreach($collections as $index => $item_collection){
            $collection = entity_load('field_collection_item', array($item_collection['value']))[$item_collection['value']];
            if( $collection->field_ruta['und'][0]['target_id'] == $user->field_ruta['und'][0]['target_id'] ){
                return $collection->field_puntaje['und'][0]['value'];
            }
        }

        return 0;

    }



